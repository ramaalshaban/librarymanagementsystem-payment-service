<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/ace.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <link rel="stylesheet" href="fee/lib/output.css?" />
    <link rel="stylesheet" href="fee/lib/styles.css?" />
    <script src="fee/lib/editor.js?"></script>
    <script src="fee/lib/toastify.js?"></script>
    <script src="fee/lib/utils.js?"></script>
    <title>Create Order</title>

    <script>
      async function fetchOrderTemplate() {
        try {
          await window.editorReady;
          const data = {};
          window.editor.setValue(data);
        } catch (error) {
          showToast("Error: " + error.message, "fa-circle-xmark text-red-500");
        }
      }

      async function submitOrder(event) {
        event.preventDefault();

        try {
          const rawData = window.editor.getValue();
          if (!rawData.trim()) {
            showToast("Editor is empty.", "fa-circle-xmark text-red-500");
            return;
          }

          let payload;
          try {
            payload = JSON.parse(rawData);
          } catch (e) {
            showToast("Invalid JSON format", "fa-circle-xmark text-red-500");
            return;
          }

          const response = await fetch("$serviceUrl$createOrderPath?", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.status) {
            throw new Error("Order creation failed.");
          }

          const data = await response.json();
          showToast(
            "Order created successfully!",
            "fa-circle-check text-green-500",
          );

          const orderId = data["fee"].id;

          setTimeout(() => {
            window.location.href = `/stripe-demo/fee/checkout-order.html?orderId=${orderId}&`;
          }, 1000);
        } catch (error) {
          showToast("Error: " + error.message, "fa-circle-xmark text-red-500");
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await fetchOrderTemplate();
      });
    </script>
  </head>

  <body
    class="bg-[#EEEEEE] h-dvh flex justify-center items-center text-[#545454]"
  >
    <main class="max-w-[90vw] lg:max-w-[50vw] w-full my-0 mx-auto">
      <div
        class="flex flex-col justify-center items-start bg-white rounded-lg overflow-hidden shadow-lg"
      >
        <!-- Header -->
        <div
          class="flex justify-between items-center gap-5 bg-[#F9F9F9] px-5 py-4 w-full"
        >
          <h1 class="flex justify-center items-center gap-2 font-bold text-md">
            <i class="fa-solid fa-credit-card"></i>
            Payment Test Page
          </h1>

          <div class="flex justify-center items-center gap-2 ml-auto">
            <img
              src="https://www.babil.com/Themes/BabilThemeV2/Content/images/babil-logo.svg"
              class="w-[25px] h-[25px] border rounded p-1"
              alt="Project Logo"
            />
            <span class="text-xs font-bold"
              >BabilShop<span class="font-light"> Project</span></span
            >
          </div>

          <div
            class="flex justify-center items-center gap-2 py-2 px-4 text-xs bg-white rounded"
          >
            <i class="fa-solid fa-user"></i>
            <span id="user-card">$userEmail</span>
          </div>
        </div>

        <!-- Order Form -->
        <form
          class="flex flex-col justify-center w-full p-5 gap-5 text-left"
          onsubmit="submitOrder(event)"
        >
          <h2 class="text-lg font-bold text-black">Create New Order</h2>

          <div
            id="editor"
            class="ace-github-light-default w-full h-[40vh] border border-gray-300 rounded-lg"
          ></div>

          <button
            type="submit"
            class="bg-black text-sm text-white p-4 rounded-lg text-center"
          >
            Create Order
          </button>
        </form>

        <!-- Footer -->
        <div
          class="flex justify-end items-center bg-[#F9F9F9] px-5 py-4 w-full"
        >
          <img src="fee/images/mindbricks.svg?" alt="mindbricks" />
        </div>
      </div>
    </main>
  </body>
</html>
